name: R-Nacos Backup

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Merge main branch into backup branch
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if ! git show-ref --quiet refs/heads/backup; then
            git checkout -b backup origin/main
          else
            git checkout backup
          fi
          
          mkdir -p .github-backup
          cp -r .github/. .github-backup/
          
          git merge origin/main --no-edit -m "Merge main into backup" -X theirs --no-ff || true
          
          rm -rf .github
          cp -r .github-backup/. .github/
          rm -rf .github-backup

      - name: Setup OpenSSL
        run: |
          sudo apt-get update
          sudo apt-get install -y openssl

      - name: Create backup directory
        run: mkdir -p deploey/backup/nacos/rnacos/backup

      - name: Generate backup filename with timestamp
        id: filename
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          BACKUP_FILENAME="rnacos_backup_${TIMESTAMP}.data"
          echo "backup_filename=$BACKUP_FILENAME" >> $GITHUB_OUTPUT
          echo "encrypted_filename=${BACKUP_FILENAME}.enc" >> $GITHUB_OUTPUT

      - name: Download rNacos backup data
        run: |
          curl -o "deploey/backup/nacos/rnacos/backup/${{ steps.filename.outputs.backup_filename }}" \
            "${{ secrets.RNACOS_BACKUP_URL }}"

      - name: Encrypt backup file
        run: |
          ENCRYPTION_KEY="${{ secrets.AES_ENCRYPTION_KEY }}"
          [ -z "$ENCRYPTION_KEY" ] && ENCRYPTION_KEY="Quantum_rNacos_Backup_2024"
          
          openssl enc -aes-256-cbc -salt \
            -in "deploey/backup/nacos/rnacos/backup/${{ steps.filename.outputs.backup_filename }}" \
            -out "deploey/backup/nacos/rnacos/backup/${{ steps.filename.outputs.encrypted_filename }}" \
            -pass pass:"$ENCRYPTION_KEY"
          rm -f "deploey/backup/nacos/rnacos/backup/${{ steps.filename.outputs.backup_filename }}"

      - name: Clean up old backups (keep last 7 days)
        run: |
          cd deploey/backup/nacos/rnacos/backup
          ls -t *.enc 2>/dev/null | tail -n +8 | xargs -r rm

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add deploey/backup/nacos/rnacos/backup/
          
          if git diff --staged --quiet; then
            echo "No new backup to commit"
            exit 0
          fi
          
          git commit -m "Add rNacos backup - $(date +'%Y-%m-%d %H:%M:%S')"
          # ✅ 关键修复：使用 --force-with-lease
          git push --force-with-lease origin backup

      - name: Upload backup artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: rnacos-backup-${{ steps.filename.outputs.backup_filename }}
          path: deploey/backup/nacos/rnacos/backup/${{ steps.filename.outputs.encrypted_filename }}
          retention-days: 7